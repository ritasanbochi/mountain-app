<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>登山向け山岳マップ</title>

<!-- Leaflet (安定CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<link rel="icon" href="data:,">

<style>
  body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
  #control{
    padding:10px; background:#f4f4f4; font-size:14px;
    display:flex; flex-wrap:wrap; gap:8px 10px; align-items:center;
  }
  #control b{ margin-right:4px; }
  #control label{ white-space:nowrap; }
  #control .group{
    display:flex; flex-wrap:wrap; gap:6px 10px; align-items:center;
    padding:4px 6px; border:1px solid #ddd; border-radius:10px; background:#fff;
  }
  .btn{ border:1px solid #cfcfcf; background:#fff; padding:6px 10px; border-radius:10px; font-size:13px; cursor:pointer; }
  .btn:hover{ background:#f7f7f7; }
  .chip{ display:inline-block; padding:1px 8px; border-radius:999px; background:#eef6ff; border:1px solid #b7d7ff; font-size:12px; margin-left:6px; }
  .ok{ background:#eaf7ee; border:1px solid #9ad3a5; }
  .danger{ background:#ffe7e7; border:1px solid #ffb8b8; }

  #container{ height:calc(100vh - 170px); position:relative; }
  #map{ height:100%; width:100%; }

  #list{
    position:absolute; top:0; right:0;
    width:320px; height:100%; overflow-y:auto;
    background:#fff; border-left:1px solid #ccc; font-size:13px; z-index:1000;
  }
  .list-item{ border-bottom:1px solid #ddd; padding:8px; cursor:pointer; }
  .list-item:hover{ background:#eef6ff; }
  .star{ color:gold; font-weight:bold; }
  .setpill{ display:inline-block; padding:1px 6px; border-radius:999px; font-size:11px; border:1px solid #ddd; background:#fafafa; margin-left:6px; }

  #detailOverlay{ position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:9999; display:none; }
  #detailOverlay.show{ display:block; }
  #detailPanel{ position:absolute; inset:0; background:#fff; display:flex; flex-direction:column; }
  #detailHeader{
    position:sticky; top:0; background:#fff; border-bottom:1px solid #ddd;
    padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  #detailHeader b{ font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70%; }
  #detailClose{ border:1px solid #ccc; background:#f7f7f7; padding:6px 10px; border-radius:8px; font-size:14px; }
  #detailBody{ padding:12px; overflow:auto; -webkit-overflow-scrolling:touch; line-height:1.5; }

  @media (min-width:769px){
    #detailPanel{
      inset:auto; top:24px; left:50%; transform:translateX(-50%);
      width:min(980px, calc(100vw - 48px)); height:min(86vh, 900px);
      border-radius:14px; box-shadow:0 14px 40px rgba(0,0,0,0.24);
    }
  }

  .wx-table{ width:100%; border-collapse:collapse; font-size:12px; }
  .wx-table th, .wx-table td{ border:1px solid #ddd; padding:4px 6px; text-align:center; }
  .wx-table th{ background:#f7f7f7; font-weight:600; }
  .wx-current{ background:#eef6ff; font-weight:700; }

  .score-grid{ width:100%; border-collapse:collapse; font-size:12px; }
  .score-grid td, .score-grid th{ border:1px solid #ddd; padding:4px 0; text-align:center; }
  .score-grid th{ background:#f7f7f7; font-weight:600; }
  .score-grid .sel{ outline:2px solid #5aa7ff; outline-offset:-2px; font-weight:800; background:#eef6ff; }
  .score-grid .a{ background:#eaf7ee; } .score-grid .b{ background:#fff7db; } .score-grid .c{ background:#ffe7e7; }
  .score-grid .p{ background:#f2f2f2; color:#666; } /* pending */

  #listHeader{ display:none; } #listTab{ display:none; }
  @media (max-width:768px){
    #container{ height:calc(100vh - 220px); }
    #list{
      position:fixed; left:0; right:0; bottom:0; top:auto; width:100%; height:45vh;
      border-left:none; border-top:1px solid #ccc; border-radius:14px 14px 0 0;
      box-shadow: 0 -6px 18px rgba(0,0,0,0.08);
      overflow:hidden; z-index:2000;
      transform: translateY(0); transition: transform 220ms ease;
      touch-action: pan-y; background:#fff;
    }
    #list.is-collapsed{ transform: translateY(100%); }
    #listHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; background:#fff; border-bottom:1px solid #eee; user-select:none;
    }
    #listHeader .title{ font-weight:700; font-size:14px; }
    #listHeader .grip{ width:42px; height:5px; border-radius:999px; background:#d8d8d8; margin:0 10px; }
    #listHeader .hint{ font-size:12px; color:#666; white-space:nowrap; }
    #listBody{ height:calc(45vh - 48px); overflow:auto; -webkit-overflow-scrolling:touch; }
    #listTab{
      display:block; position:fixed; left:12px; bottom:12px; z-index:2500;
      padding:10px 12px; border-radius:999px; border:1px solid #cfcfcf; background:#fff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12); font-size:13px;
    }
    #listTab.hidden{ display:none; }
  }
</style>
</head>

<body>
<div id="control">
  <div class="group">
    <b>日付</b>
    <select id="day">
      <option value="0">今日</option>
      <option value="1">1日後</option>
      <option value="2">2日後</option>
      <option value="3">3日後</option>
    </select>

    <b>時間帯</b>
    <input type="range" id="timeSlider" min="0" max="5" value="0">
    <span id="timeLabel">06–08</span>
  </div>

  <div class="group">
    <b>山セット</b>
    <label><input type="checkbox" class="setChk" value="HYAKU" checked>百名山</label>
    <label><input type="checkbox" class="setChk" value="HANA_100">花の百名山</label>
    <label><input type="checkbox" class="setChk" value="NIHON_200">二百名山</label>
    <label><input type="checkbox" class="setChk" value="NIHON_300">三百名山</label>
  </div>

  <div class="group">
    <b>天気</b>
    <label><input type="checkbox" value="A" checked>A</label>
    <label><input type="checkbox" value="B" checked>B</label>
    <label><input type="checkbox" value="C" checked>C</label>
    <label><input type="checkbox" value="P" checked>未取得</label>
  </div>

  <div class="group">
    <b>難易度</b>
    <label><input type="checkbox" value="初級" checked>初級</label>
    <label><input type="checkbox" value="中級" checked>中級</label>
    <label><input type="checkbox" value="上級" checked>上級</label>
    <label style="margin-left:6px;"><input type="checkbox" id="goodOnly"> 登れる山だけ</label>
  </div>

  <div class="group">
    <span id="setStatus" style="font-size:12px;color:#444; max-width: 78vw;"></span>
  </div>
</div>

<div id="container">
  <div id="map"></div>
  <div id="list">
    <div id="listHeader">
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="grip" aria-hidden="true"></div>
        <div class="title">山リスト</div>
      </div>
      <div class="hint">下へスワイプ / タップで隠す</div>
    </div>
    <div id="listBody"></div>
  </div>
</div>

<button id="listTab" class="hidden" type="button">山リスト</button>

<div id="detailOverlay" aria-hidden="true">
  <div id="detailPanel" role="dialog" aria-modal="true" aria-label="山の詳細">
    <div id="detailHeader">
      <b id="detailTitle">山の詳細</b>
      <button id="detailClose" type="button">閉じる</button>
    </div>
    <div id="detailBody"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<script type="module">
import mountains from "./mountains.js";
import mountainsExtra from "./mountains_extra.js";
import { generateWeatherScore } from "./weather.js";

/* ========= utilities ========= */
const timeSlots  = ["06:00","08:00","10:00","12:00","14:00","16:00"];
const timeLabels = ["06–08","08–10","10–12","12–14","14–16","16–18"];
const slider = document.getElementById("timeSlider");
const timeLabel = document.getElementById("timeLabel");
const daySelect = document.getElementById("day");
const setStatus = document.getElementById("setStatus");

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function setStatusHtml(lines){
  const safe = (lines || []).filter(Boolean).slice(0, 22).map(s => escapeHtml(s));
  setStatus.innerHTML = safe.join("<br>");
}
function pad2(n){ return String(n).padStart(2, "0"); }
function formatLocalYMD(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function getDateKey(offset){
  const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate() + offset);
  return formatLocalYMD(d);
}
function normName(s){
  return String(s ?? "").trim().replace(/\s+/g,"").replace(/[（(].*?[）)]/g,"");
}
function setLabel(k){
  const MAP = {HYAKU:"百名山",HANA_100:"花の百名山",NIHON_200:"二百名山",NIHON_300:"三百名山"};
  return MAP[k] ?? k;
}

/* ========= 429対策：同時実行制限 ========= */
async function runWithConcurrency(tasks, concurrency, onProgress){
  let idx = 0, active = 0, done = 0;
  const results = new Array(tasks.length);

  return new Promise((resolve) => {
    const next = () => {
      if (done === tasks.length) return resolve(results);
      while (active < concurrency && idx < tasks.length){
        const cur = idx++;
        active++;
        Promise.resolve()
          .then(() => tasks[cur]())
          .then(res => { results[cur] = res; })
          .catch(err => { results[cur] = { __error: err }; })
          .finally(() => {
            active--;
            done++;
            onProgress?.(done, tasks.length);
            next();
          });
      }
    };
    next();
  });
}

/* ========= map ========= */
const mapObj = L.map("map").setView([36.5, 138], 5);
L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", { maxZoom:18, attribution:"地理院タイル" }).addTo(mapObj);
L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png", { maxZoom:16, opacity:0.35, attribution:"地理院陰影" }).addTo(mapObj);

const listEl = document.getElementById("list");
const listBody = document.getElementById("listBody");
const listTab = document.getElementById("listTab");
const listHeader = document.getElementById("listHeader");

const overlay = document.getElementById("detailOverlay");
const detailTitle = document.getElementById("detailTitle");
const detailBody  = document.getElementById("detailBody");
document.getElementById("detailClose").addEventListener("click", () => {
  overlay.classList.remove("show");
  overlay.setAttribute("aria-hidden","true");
});
overlay.addEventListener("click", (e) => {
  if (e.target === overlay){
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
  }
});

/* ========= list (mobile) ========= */
function isMobile(){ return window.matchMedia("(max-width:768px)").matches; }
function setListCollapsed(collapsed){
  if (!isMobile()) return;
  listEl.classList.toggle("is-collapsed", !!collapsed);
}
function syncListTab(){
  if (!isMobile()){
    listTab.classList.add("hidden");
    return;
  }
  const collapsed = listEl.classList.contains("is-collapsed");
  listTab.classList.toggle("hidden", !collapsed);
}
listTab.addEventListener("click", () => {
  setListCollapsed(false);
  syncListTab();
});
listHeader.addEventListener("click", () => {
  setListCollapsed(true);
  syncListTab();
});

/* ========= day/time label ========= */
function nearestSlotIndex(){
  const now = new Date();
  const h = now.getHours();
  const slots = [6,8,10,12,14,16];
  let best=0, bestDiff=1e9;
  slots.forEach((s,i)=>{
    const d = Math.abs(h - s);
    if (d < bestDiff){ bestDiff=d; best=i; }
  });
  return best;
}
function updateTimeLabel(){
  const idx = Number(slider.value);
  timeLabel.textContent = timeLabels[idx] ?? "06–08";
}
updateTimeLabel();

/* ========= merge mountains ========= */
function mergeAll(){
  const map = new Map();
  const push = (m) => {
    const name = m.name ?? "";
    const key = normName(name);
    const lat = Number(m.lat ?? m.latitude);
    const lng = Number(m.lng ?? m.lon ?? m.longitude);
    const elev = (m.elev ?? m.elevation);
    const level = m.level ?? "中級";
    const sets = Array.isArray(m._sets) ? m._sets.slice() : [];
    const base = {
      name, lat, lng,
      elev: elev==null?null:Number(elev),
      level,
      weather: m.weather ?? {},
      gpx: m.gpx ?? null,
      _sets: sets
    };

    const prev = map.get(key);
    if (prev){
      const s = new Set([...(prev._sets||[]), ...(base._sets||[])]);
      map.set(key, {
        ...base,
        ...prev,
        _sets: [...s]
      });
    }else{
      map.set(key, base);
    }
  };

  mountains.forEach(m => push({ ...m, _sets: ["HYAKU", ...(m._sets||[])] }));
  mountainsExtra.forEach(m => push(m));

  return [...map.values()];
}

let ALL = mergeAll();

/* ========= filters ========= */
function selectedSetKeys(){
  return [...document.querySelectorAll(".setChk:checked")].map(e => e.value);
}
function selectedScores(){
  return [...document.querySelectorAll('#control input[type="checkbox"]')]
    .filter(e => ["A","B","C","P"].includes(e.value) && e.checked)
    .map(e => e.value);
}
function selectedLevels(){
  return [...document.querySelectorAll('#control input[type="checkbox"]')]
    .filter(e => ["初級","中級","上級"].includes(e.value) && e.checked)
    .map(e => e.value);
}
function filterMountains(){
  const sets = new Set(selectedSetKeys());
  const scores = new Set(selectedScores());
  const levels = new Set(selectedLevels());
  const goodOnly = document.getElementById("goodOnly").checked;

  return ALL.filter(m => {
    if (!Number.isFinite(m.lat) || !Number.isFinite(m.lng)) return false;
    if (levels.size && !levels.has(m.level)) return false;

    if (sets.size){
      const has = (m._sets || []).some(s => sets.has(s));
      if (!has) return false;
    }

    const sc = m.weather?.score ?? "P";
    if (scores.size && !scores.has(sc)) return false;
    if (goodOnly && sc !== "A") return false;

    return true;
  });
}

/* ========= marker + list ========= */
const markerLayer = L.layerGroup().addTo(mapObj);
const markerMap = new Map();

/* 元HTMLのピン色ロジック・更新ロジックを保持（このファイルは固定化機能のみ除去） */
function makeSvgIcon(color){
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26">
    <circle cx="13" cy="13" r="10" fill="${color}" stroke="#222" stroke-width="2"/>
  </svg>`;
  return L.icon({
    iconUrl: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg),
    iconSize: [26,26],
    iconAnchor: [13,13]
  });
}
const icons = {
  A: makeSvgIcon("#2ecc71"),
  B: makeSvgIcon("#f1c40f"),
  C: makeSvgIcon("#e74c3c"),
  P: makeSvgIcon("#aaaaaa")
};

function clearMarkers(){
  markerLayer.clearLayers();
  markerMap.clear();
}

function openDetail(m){
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");
  detailTitle.textContent = m.name;

  const elev = (m.elev==null) ? "-" : `${Math.round(m.elev)}m`;
  const sets = (m._sets||[]).map(setLabel).join(" / ");
  const lv = m.level ?? "-";
  const score = m.weather?.score ?? "P";
  const w = m.weather?.detail ?? null;

  let html = "";
  html += `<div><b>標高</b>：${escapeHtml(elev)}　<b>難易度</b>：${escapeHtml(lv)}　<b>セット</b>：${escapeHtml(sets)}</div>`;
  html += `<div style="margin-top:6px;"><b>スコア</b>：<span class="chip ${score==="A"?"ok":(score==="C"?"danger":"")}">${escapeHtml(score)}</span></div>`;

  if (w){
    html += `<hr style="border:none;border-top:1px solid #eee;margin:10px 0;">`;
    html += `<div style="font-size:13px;color:#333;">${escapeHtml(w.reason ?? "")}</div>`;
    html += `<div style="font-size:12px;color:#666;margin-top:4px;">取得: ${escapeHtml(w.fetchedAt ?? "")} / 元: ${escapeHtml(w.source ?? "")}</div>`;
    html += `<div style="margin-top:10px;">`;
    html += `<table class="wx-table"><tr><th></th><th>降水</th><th>風速</th><th>突風</th><th>気温</th></tr>`;
    html += `<tr><th>山頂</th><td>${escapeHtml(w.precip ?? "-")}</td><td>${escapeHtml(w.wind ?? "-")}</td><td>${escapeHtml(w.gust ?? "-")}</td><td>${escapeHtml(w.temp ?? "-")}</td></tr>`;
    if (w.mid){
      html += `<tr><th>中腹</th><td>${escapeHtml(w.mid.precip ?? "-")}</td><td>${escapeHtml(w.mid.wind ?? "-")}</td><td>${escapeHtml(w.mid.gust ?? "-")}</td><td>${escapeHtml(w.mid.temp ?? "-")}</td></tr>`;
    }
    html += `</table>`;
    html += `</div>`;
  }else{
    html += `<div style="margin-top:10px;color:#666;font-size:12px;">天気：未取得（自動取得中）</div>`;
  }

  detailBody.innerHTML = html;
}

function addMarker(m){
  const score = m.weather?.score ?? "P";
  const icon = icons[score] ?? icons.P;
  const marker = L.marker([m.lat, m.lng], { icon });
  marker.on("click", () => openDetail(m));
  marker.addTo(markerLayer);
  markerMap.set(normName(m.name), marker);
}

function repaintMarker(m){
  const key = normName(m.name);
  const marker = markerMap.get(key);
  if (!marker) return;
  const score = m.weather?.score ?? "P";
  const icon = icons[score] ?? icons.P;
  marker.setIcon(icon);
}

function renderList(items){
  const bounds = mapObj.getBounds();
  const inView = items.filter(m => bounds.contains([m.lat, m.lng]));
  const target = inView.length ? inView : items;

  target.sort((a,b) => (b.elev||0) - (a.elev||0));

  let html = "";
  for (const m of target){
    const score = m.weather?.score ?? "P";
    const elev = (m.elev==null) ? "-" : `${Math.round(m.elev)}m`;
    const sets = (m._sets||[]).map(setLabel).join(",");
    html += `<div class="list-item" data-name="${escapeHtml(m.name)}">`;
    html += `<b>${escapeHtml(m.name)}</b> <span class="chip ${score==="A"?"ok":(score==="C"?"danger":"")}">${escapeHtml(score)}</span>`;
    html += `<div style="margin-top:2px;color:#666;">${escapeHtml(elev)} / ${escapeHtml(m.level ?? "-")} <span class="setpill">${escapeHtml(sets)}</span></div>`;
    html += `</div>`;
  }
  listBody.innerHTML = html;

  listBody.querySelectorAll(".list-item").forEach(el => {
    el.addEventListener("click", () => {
      const name = el.getAttribute("data-name");
      const mm = ALL.find(x => normName(x.name) === normName(name));
      if (!mm) return;
      mapObj.setView([mm.lat, mm.lng], Math.max(mapObj.getZoom(), 10));
      openDetail(mm);
      if (isMobile()){
        setListCollapsed(true);
        syncListTab();
      }
    });
  });

  const selSets = selectedSetKeys().map(setLabel).join(" / ");
  setStatusHtml([
    `登録: 百=${mountains.length} / 追加=${mountainsExtra.length} / 合計ユニーク=${ALL.length}`,
    `選択セット: ${selSets || "なし"}`,
    `表示: ${items.length}（画面内: ${inView.length}）`
  ]);
}

/* ========= Weather on demand (範囲内だけ) ========= */
let weatherQueueRunning = false;

async function runWeatherQueue(items){
  if (weatherQueueRunning) return;
  weatherQueueRunning = true;

  try{
    const targets = items.filter(m => !(m.weather && m.weather.score) || m.weather.score === "P");

    const tasks = targets.map(m => async () => {
      const dayOffset = Number(daySelect.value);
      const slotIndex = Number(slider.value);

      let lastErr = null;
      for (let t=0; t<3; t++){
        try{
          m.weather = await generateWeatherScore(m.name, m.lat, m.lng, m.level, m.elev, dayOffset, slotIndex);
          repaintMarker(m);
          lastErr = null;
          break;
        }catch(e){
          lastErr = e;
          await sleep(350 + t*550);
        }
      }
      if (lastErr) console.warn("[weather] failed:", m.name, lastErr);
    });

    let last = 0;
    await runWithConcurrency(tasks, 2, (done, total) => {
      if (done - last >= 12 || done === total){
        last = done;
        update(false);
      }
    });
  }finally{
    weatherQueueRunning = false;
  }
}

/* ========= update ========= */
function update(triggerWeather=true){
  const items = filterMountains();
  clearMarkers();
  items.forEach(addMarker);
  renderList(items);

  if (triggerWeather){
    runWeatherQueue(items);
  }
}

/* ========= event wiring ========= */
document.querySelectorAll("#control input, #control select").forEach(el => {
  el.addEventListener("change", () => {
    if (el === daySelect && String(daySelect.value) === "0"){
      slider.value = String(nearestSlotIndex());
      updateTimeLabel();
    }
    update(true);
  });
});
slider.addEventListener("input", () => {
  updateTimeLabel();
  update(false);
});

mapObj.on("moveend zoomend", () => update(false));

if (String(daySelect.value) === "0"){
  slider.value = String(nearestSlotIndex());
  updateTimeLabel();
}

update(true);
syncListTab();
</script>
</body>
</html>
