<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>百名山 登山マップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

/* ===== コントロール ===== */
#control{
  padding:8px 10px;
  background:#f4f4f4;
  font-size:14px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

/* ===== レイアウト ===== */
#container{ height:calc(100vh - 110px); position:relative; }
#map{ height:100%; width:100%; }

/* ===== リスト ===== */
#list{
  position:absolute;
  right:0; top:0;
  width:300px; height:100%;
  overflow-y:auto;
  background:#fff;
  border-left:1px solid #ccc;
  font-size:13px;
  z-index:1000;
}

/* ===== popup ===== */
.leaflet-popup-content{
  max-width:340px;
}
.popup h3{
  margin:0 0 4px;
  font-size:16px;
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:12px;
  font-size:11px;
}
.badge-api{ background:#e7f7ea; }
.badge-dummy{ background:#fff0f0; }

hr{ border:none; border-top:1px solid #ddd; margin:6px 0; }

/* ===== tables ===== */
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th, td{
  border:1px solid #ddd;
  padding:4px;
  text-align:center;
}
th{ background:#f7f7f7; }

/* ===== fold ===== */
details summary{
  cursor:pointer;
  font-weight:600;
  padding:6px 0;
}

/* ===== スマホ最適化 ===== */
@media (max-width:768px){
  #list{
    width:100%;
    height:42%;
    bottom:0; top:auto;
    border-left:none;
    border-top:1px solid #ccc;
  }
  .leaflet-popup-content{
    font-size:14px;
    line-height:1.5;
  }
  table{ font-size:13px; }
}
</style>
</head>

<body>

<div id="control">
  <b>日付</b>
  <select id="day">
    <option value="0">今日</option>
    <option value="1">1日後</option>
    <option value="2">2日後</option>
    <option value="3">3日後</option>
  </select>

  <b>時間</b>
  <input type="range" id="timeSlider" min="0" max="5" value="0">
  <span id="timeLabel">06–08</span>
</div>

<div id="container">
  <div id="map"></div>
  <div id="list"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import mountains from "./mountains.js";
import { generateWeatherScore } from "./weather.js";

const timeSlots = ["06:00","08:00","10:00","12:00","14:00","16:00"];
const timeLabels = ["06–08","08–10","10–12","12–14","14–16","16–18"];

const slider = document.getElementById("timeSlider");
const timeLabel = document.getElementById("timeLabel");
slider.oninput = () => timeLabel.textContent = timeLabels[slider.value];
const getSelectedTime = () => timeSlots[slider.value];

function getDateKey(d){
  const t = new Date();
  t.setDate(t.getDate()+d);
  return t.toISOString().slice(0,10);
}

const map = L.map("map").setView([36.5,138],5);
L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png").addTo(map);

const markerLayer = L.layerGroup().addTo(map);

function popupHtml(m){
  const day = Number(document.getElementById("day").value);
  const time = getSelectedTime();
  const score = m.weather?.[getDateKey(day)]?.[time] ?? "-";

  return `
    <div class="popup">
      <h3>${m.name}</h3>
      <span class="badge ${m.weather._meta?.source==="api"?"badge-api":"badge-dummy"}">
        ${m.weather._meta?.source?.toUpperCase() || "DUMMY"}
      </span>

      <hr>
      <b>おすすめ</b><br>
      ${day===0?"今日":"+"+day+"日"} ${timeLabels[slider.value]}：<b>${score}</b>

      <details>
        <summary>スコア早見表</summary>
        <table>
          <tr><th></th>${timeLabels.map(t=>`<th>${t}</th>`).join("")}</tr>
          ${[0,1,2,3].map(d=>`
            <tr>
              <th>${d===0?"今日":"+"+d+"日"}</th>
              ${timeSlots.map(t=>`<td>${m.weather?.[getDateKey(d)]?.[t]||"-"}</td>`).join("")}
            </tr>
          `).join("")}
        </table>
      </details>
    </div>
  `;
}

(async()=>{
  for(const m of mountains){
    m.weather = await generateWeatherScore(m.name,m.lat,m.lng);
    const marker = L.marker([m.lat,m.lng]).addTo(markerLayer);
    marker.bindPopup(popupHtml(m));
  }
})();
</script>

</body>
</html>
