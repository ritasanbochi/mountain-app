<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>登山向け山岳マップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="icon" href="data:,">

<style>
  body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
  #control{
    padding:10px 12px;
    background:#fff;
    border-bottom:1px solid #ddd;
    position:sticky; top:0; z-index:999;
  }
  #map { height: calc(100vh - 126px); }

  .group { display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; margin:6px 0; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #ddd; border-radius:999px; background:#fafafa; }
  .btn { padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .hr { height:1px; background:#eee; margin:8px 0; }

  /* bottom list */
  #listSheet{
    position:fixed; left:0; right:0; bottom:0;
    background:rgba(255,255,255,.98);
    border-top:1px solid #ddd;
    border-top-left-radius:14px;
    border-top-right-radius:14px;
    box-shadow: 0 -8px 24px rgba(0,0,0,.12);
    max-height: 55vh;
    display:flex; flex-direction:column;
    z-index: 1200;
  }
  #sheetHeader{ padding:10px 12px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  #sheetHandle{ width:48px; height:5px; border-radius:999px; background:#ddd; margin:0 auto; }
  #listBody{ overflow:auto; padding:8px 10px 12px; }
  .row { display:flex; gap:10px; padding:10px 8px; border-bottom:1px solid #f0f0f0; cursor:pointer; }
  .row:hover { background:#fafafa; }
  .badge { width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800; border:1px solid transparent; }
  .A { background:#e9f8ee; color:#117a2a; border-color:#bfe8c8; }
  .B { background:#fff7e6; color:#9a6a00; border-color:#ffe0a8; }
  .C { background:#ffe9ea; color:#a1151a; border-color:#ffc2c4; }
  .N { background:#f3f4f6; color:#374151; border-color:#e5e7eb; }
  .name { font-weight:800; }
  .meta { font-size:12px; opacity:.75; }

  /* overlay detail */
  #overlay{
    position:fixed; inset:0; display:none;
    background:rgba(0,0,0,.35);
    align-items:flex-end;
    z-index: 2000;
  }
  #panel{
    width:100%;
    max-height: 75vh;
    background:#fff;
    border-top-left-radius:16px;
    border-top-right-radius:16px;
    box-shadow: 0 -10px 30px rgba(0,0,0,.2);
    overflow:auto;
  }
  #panelHeader{
    padding:12px 14px;
    border-bottom:1px solid #eee;
    display:flex; align-items:center; gap:10px;
  }
  #panelBody{ padding:12px 14px 18px; }
  .kv { display:grid; grid-template-columns: 120px 1fr; gap: 8px 10px; font-size:14px; }
  .kv div:nth-child(odd){ opacity:.7; }

  #statusLine{
    margin-top:6px;
    font-size:12px;
    color:#111;
    white-space:pre-wrap;
  }

  @media (min-width: 900px){
    #map { height: calc(100vh - 116px); }
    #listSheet{
      left:10px; right:auto; bottom:10px;
      width:420px;
      max-height: calc(100vh - 140px);
      border:1px solid #ddd;
      border-radius:14px;
    }
  }
</style>
</head>

<body>
<div id="control">
  <div class="group">
    <b>表示セット</b>
    <label class="chip"><input type="checkbox" class="setChk" value="HYAKU" checked>百名山</label>
    <label class="chip"><input type="checkbox" class="setChk" value="HANA_100">花の百名山</label>
    <label class="chip"><input type="checkbox" class="setChk" value="NIHON_200">二百名山</label>
    <label class="chip"><input type="checkbox" class="setChk" value="NIHON_300">三百名山</label>
  </div>

  <div class="group">
    <b>難易度</b>
    <label class="chip"><input type="checkbox" value="初級" checked>初級</label>
    <label class="chip"><input type="checkbox" value="中級" checked>中級</label>
    <label class="chip"><input type="checkbox" value="上級" checked>上級</label>
    <label class="chip" style="margin-left:6px;"><input type="checkbox" id="goodOnly"> 登れる山だけ</label>
  </div>

  <div class="hr"></div>

  <div class="group">
    <b>天気</b>
    <select id="day" class="btn">
      <option value="0">今日</option>
      <option value="1">+1日</option>
      <option value="2">+2日</option>
      <option value="3">+3日</option>
    </select>

    <input id="timeSlider" type="range" min="0" max="5" step="1" value="0" style="flex:1; min-width:160px;">
    <span class="chip" id="timeLabel">06:00</span>

    <button class="btn" id="listTab" type="button">山リスト</button>
    <button class="btn" id="toJapan" type="button">日本全体</button>
  </div>

  <div id="statusLine"></div>
</div>

<div id="map"></div>

<!-- bottom list -->
<div id="listSheet">
  <div id="sheetHeader">
    <div style="width:100%;">
      <div id="sheetHandle"></div>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px;">
        <div>
          <div style="font-weight:900;">山リスト</div>
          <div class="meta" id="countLine">表示: 0</div>
        </div>
        <button class="btn" id="closeList" type="button">閉じる</button>
      </div>
    </div>
  </div>
  <div id="listBody"></div>
</div>

<!-- overlay -->
<div id="overlay">
  <div id="panel">
    <div id="panelHeader">
      <div class="badge N" id="ovBadge">…</div>
      <div>
        <div class="name" id="ovName">---</div>
        <div class="meta" id="ovMeta">---</div>
      </div>
      <button class="btn" id="detailClose" type="button" style="margin-left:auto;">閉じる</button>
    </div>
    <div id="panelBody">
      <div class="kv" id="ovKv"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import mountains from "./mountains.js";
import mountainsExtra from "./mountains_extra.js";
import { generateWeatherScore } from "./weather.js";

/* ========= utilities ========= */
const timeSlots  = ["06:00","08:00","10:00","12:00","14:00","16:00"];
const timeSlots2 = ["06–08","08–10","10–12","12–14","14–16","16–18"];
const slider = document.getElementById("timeSlider");
const timeLabel = document.getElementById("timeLabel");
const daySelect = document.getElementById("day");
const statusLine = document.getElementById("statusLine");

const SET_LABELS = { HYAKU:"百名山", HANA_100:"花の百名山", NIHON_200:"二百名山", NIHON_300:"三百名山" };
function setLabel(k){ return SET_LABELS[k] || k; }

function normName(s){
  return String(s ?? "").trim().replace(/\s+/g,"").replace(/[（(].*?[）)]/g,"");
}

function badgeClass(score){
  if (score === "A") return "A";
  if (score === "B") return "B";
  if (score === "C") return "C";
  return "N";
}

/* ========= 429対策：同時実行制限 ========= */
async function runWithConcurrency(tasks, concurrency, onProgress){
  let idx = 0, active = 0, done = 0;
  const results = new Array(tasks.length);

  return new Promise((resolve, reject) => {
    const next = () => {
      if (done === tasks.length) return resolve(results);
      while (active < concurrency && idx < tasks.length){
        const cur = idx++;
        active++;
        Promise.resolve()
          .then(() => tasks[cur]())
          .then(res => { results[cur] = res; })
          .catch(err => { results[cur] = { __error: err }; })
          .finally(() => {
            active--;
            done++;
            onProgress?.(done, tasks.length);
            next();
          });
      }
    };
    next();
  });
}

/* ========= map ========= */
const map = L.map("map", { zoomControl: true }).setView([36.2, 138.2], 6);

L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: "地理院タイル"
}).addTo(map);

L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png", {
  maxZoom: 16,
  opacity: 0.35,
  attribution: "地理院陰影"
}).addTo(map);

/* ========= data merge ========= */
function mergeAll(){
  const byId = new Map();

  for (const m of mountains){
    // mountains.js 側は id/name/lat/lng/elev/level を前提（lat/lng が違う場合は下の方で調整）
    const lat = (m.lat ?? m.latitude);
    const lng = (m.lng ?? m.lon ?? m.longitude);
    byId.set(m.id, {
      ...m,
      lat, lng,
      elev: m.elev ?? m.elevation,
      level: m.level ?? "中級",
      _sets: Array.isArray(m._sets) ? m._sets.slice() : ["HYAKU"]
    });
  }

  for (const m of mountainsExtra){
    const lat = (m.lat ?? m.latitude);
    const lng = (m.lng ?? m.lon ?? m.longitude);
    const obj = {
      ...m,
      lat, lng,
      elev: m.elev ?? m.elevation,
      level: m.level ?? "中級",
      _sets: Array.isArray(m._sets) ? m._sets.slice() : []
    };
    const prev = byId.get(m.id);
    if (prev){
      const set = new Set([...(prev._sets||[]), ...(obj._sets||[])]);
      byId.set(m.id, { ...prev, ...obj, _sets:[...set] });
    } else {
      byId.set(m.id, obj);
    }
  }

  return [...byId.values()];
}

let ALL = mergeAll();

/* ========= markers ========= */
const markerLayer = L.layerGroup().addTo(map);
const markerMap = new Map(); // id -> marker

function selectedSetKeys(){
  return [...document.querySelectorAll(".setChk:checked")].map(e => e.value);
}
function selectedLevels(){
  return [...document.querySelectorAll('#control input[type="checkbox"]')]
    .filter(e => ["初級","中級","上級"].includes(e.value) && e.checked)
    .map(e => e.value);
}

function filterMountains(){
  const setKeys = new Set(selectedSetKeys());
  const lv = new Set(selectedLevels());
  const goodOnly = document.getElementById("goodOnly").checked;

  return ALL.filter(m => {
    const lat = Number(m.lat), lng = Number(m.lng);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return false;
    if (lv.size && !lv.has(m.level)) return false;
    if (setKeys.size && !(m._sets || []).some(s => setKeys.has(s))) return false;
    if (goodOnly && m.weather?.score && m.weather.score !== "A") return false;
    return true;
  });
}

function clearMarkers(){
  markerLayer.clearLayers();
  markerMap.clear();
}

function addMarkerForMountain(m){
  const marker = L.marker([m.lat, m.lng]);
  marker.on("click", () => openDetail(m));
  marker.addTo(markerLayer);
  markerMap.set(m.id, marker);
}

function repaintMarker(m){
  // Leaflet標準アイコンは色変更しづらいので、簡易に “ポップアップ/リスト側” を主にする
  // ここでは何もしない（既存挙動を壊さない）
}

/* ========= list + detail ========= */
const listSheet = document.getElementById("listSheet");
const listBody = document.getElementById("listBody");
const countLine = document.getElementById("countLine");

const overlay = document.getElementById("overlay");
const ovBadge = document.getElementById("ovBadge");
const ovName = document.getElementById("ovName");
const ovMeta = document.getElementById("ovMeta");
const ovKv = document.getElementById("ovKv");

document.getElementById("detailClose").onclick = () => overlay.style.display = "none";
overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = "none"; };

document.getElementById("listTab").onclick = () => {
  listSheet.style.display = (listSheet.style.display === "none") ? "flex" : "none";
};
document.getElementById("closeList").onclick = () => listSheet.style.display = "none";

document.getElementById("toJapan").onclick = () => map.setView([36.2, 138.2], 6);

function openDetail(m){
  overlay.style.display = "flex";

  const score = m.weather?.score ?? "…";
  ovBadge.className = "badge " + badgeClass(score);
  ovBadge.textContent = score;

  ovName.textContent = m.name;
  ovMeta.textContent = `${Math.round(m.elev||0)}m / ${(m._sets||[]).map(setLabel).join(",")} / ${Number(m.lat).toFixed(5)}, ${Number(m.lng).toFixed(5)}`;

  ovKv.innerHTML = "";
  const add = (k,v) => {
    const a=document.createElement("div"); a.textContent = k;
    const b=document.createElement("div"); b.textContent = v;
    ovKv.appendChild(a); ovKv.appendChild(b);
  };

  if (m.weather?.detail){
    add("降水", m.weather.detail.precip ?? "-");
    add("風速", m.weather.detail.wind ?? "-");
    add("突風", m.weather.detail.gust ?? "-");
    add("気温", m.weather.detail.temp ?? "-");
    add("根拠", m.weather.detail.reason ?? "-");
    add("データ元", m.weather.detail.source ?? "-");
    add("取得時刻", m.weather.detail.fetchedAt ?? "-");
  } else {
    add("天気", "未取得（自動取得中）");
  }
}

function renderList(items){
  listBody.innerHTML = "";

  // 画面内優先 → なければ全件
  const bounds = map.getBounds();
  const inView = items.filter(m => bounds.contains([m.lat, m.lng]));
  const target = inView.length ? inView : items;

  target.sort((a,b) => (b.elev||0) - (a.elev||0));

  for (const m of target){
    const score = m.weather?.score ?? "…";
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="badge ${badgeClass(score)}">${score}</div>
      <div style="min-width:0;">
        <div class="name">${m.name}</div>
        <div class="meta">${Math.round(m.elev||0)}m / ${(m._sets||[]).map(setLabel).join(",")}</div>
      </div>
    `;
    row.onclick = () => {
      map.setView([m.lat, m.lng], Math.max(map.getZoom(), 11));
      openDetail(m);
    };
    listBody.appendChild(row);
  }

  countLine.textContent = `表示: ${items.length} / 画面内: ${inView.length}`;
}

/* ========= weather auto fetch ========= */
function setStatus(lines){
  statusLine.textContent = (lines || []).join("\n");
}

async function autoFetchWeather(mountains){
  // まだ未取得のものだけ
  const targets = mountains.filter(m => !(m.weather && Object.keys(m.weather).length));
  if (!targets.length) return;

  const tasks = targets.map(m => async () => {
    try{
      m.weather = await generateWeatherScore(m.name, m.lat, m.lng, m.level, m.elev);
    } catch (e){
      // 失敗時も落とさない（weather.js 側でダミー生成がある前提）
      console.warn("[weather] fetch failed:", m.name, e);
    }
  });

  let last = 0;
  await runWithConcurrency(tasks, 2, (done, total) => {
    // 進捗の出しすぎ抑制
    if (done - last >= 12 || done === total){
      last = done;
      setStatus([
        `固定データ統合: 合計${ALL.length}件`,
        `天気取得: ${done}/${total}（同時2本 / キャッシュあり）`,
        `※天気は初回に順次取得（429対策あり）`
      ]);
      // リスト表示も少しずつ更新
      updateView(false);
    }
  });
}

let updating = false;

function updateView(triggerWeather = true){
  if (updating) return;
  updating = true;

  try{
    const items = filterMountains();
    clearMarkers();
    for (const m of items) addMarkerForMountain(m);
    renderList(items);

    // 天気を “勝手に” 読みにいく（地図を動かさなくても）
    if (triggerWeather) {
      // 非同期で投げる（UIブロックしない）
      autoFetchWeather(items);
    }

  } finally {
    updating = false;
  }
}

/* ========= time/day UI ========= */
function nearestSlotIndex(){
  const now = new Date();
  const h = now.getHours();
  // 06/08/10/12/14/16 を基準に最近傍
  const slots = [6,8,10,12,14,16];
  let best = 0, bestDiff = 1e9;
  slots.forEach((s,i) => {
    const d = Math.abs(h - s);
    if (d < bestDiff){ bestDiff = d; best = i; }
  });
  return best;
}
function updateTimeLabel(){
  const idx = Number(slider.value);
  timeLabel.textContent = timeSlots[idx];
}
slider.addEventListener("input", () => { updateTimeLabel(); updateView(false); });
daySelect.addEventListener("change", () => {
  // 今日に戻した時は “現在時刻に近い枠” に戻す（既存方針）
  if (String(daySelect.value) === "0"){
    slider.value = String(nearestSlotIndex());
    updateTimeLabel();
  }
  updateView(false);
});

updateTimeLabel();

/* ========= init ========= */
function init(){
  setStatus([`固定データ統合中...`]);

  // 初回はリスト閉じない（スマホで邪魔なら手で閉じる）
  listSheet.style.display = "flex";

  // コントロール変更で更新
  document.querySelectorAll("#control input,#control select").forEach(e => {
    if (e === daySelect) return;
    e.addEventListener("change", () => updateView(true));
  });

  // map操作でも “画面内優先” の表示が変わるので更新（ただし天気取得は既にautoなので false）
  map.on("moveend zoomend", () => updateView(false));

  updateView(true);
}
init();
</script>
</body>
</html>
